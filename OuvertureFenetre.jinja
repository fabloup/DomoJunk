{% set tExt  = states('sensor.mougins_temperature')|float(0) %}
{% set dExt = states('sensor.derivee_mougins_temp')|float(0) %}
{% set tInt = states('sensor.salon_temperature')|float(0) %}
{% set dInt = states('sensor.derivee_salon_temp')|float(0) %}

{# --- Détection saison (simple) --- #}
{% set saison = 'ete' if tInt > 23 else 'hiver' %}

{# --- Seuils communs --- #}
{% set seuilDerive = 0.1 %}
{% set seuilTempEcart = 1 %}

{# --- Seuils spécifiques par saison --- #}
{% if saison == 'ete' %}
  {% set seuilTempExt = 27.5 %}
  {% set seuilTempIntBase = 26 %}
{% else %}
  {% set seuilTempExt = 8 %}
  {% set seuilTempIntBase = 18 %}
{% endif %}

{# --- Calcul d'écart de température --- #}
{% set ecartTemp = tExt - tInt %}

{# --- Conditions de fermeture --- #}
{% if saison == 'ete' %}
  {% set fermer = 
    (tExt >= seuilTempExt) and (
      dExt > seuilDerive or
      (dInt > seuilDerive and tInt > seuilTempIntBase) or
      ecartTemp > seuilTempEcart
    )
  %}
{% else %}
  {# hiver : ouvrir si l’air extérieur peut réchauffer ou si la pièce se refroidit trop lentement #}
  {% set fermer = (
      (tExt < seuilTempExt)
      or (dExt < -seuilDerive and tExt < tInt)
      or (dInt < -seuilDerive and tInt < seuilTempIntBase)
    )
  %}
  
{% endif %}


{# --- Conditions d’ouverture --- #}
{% if saison == 'ete' %}
  {% set ouvrir = tExt < seuilTempExt %}
{% else %}
  {% set ouvrir = (tExt > seuilTempExt + 1) and (tExt > tInt + seuilTempEcart) %}
{% endif %}

{# --- Résultat final --- #}
{{ ouvrir and not fermer }}
